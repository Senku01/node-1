name: Continuous Recon Runner

permissions:
  contents: read

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

concurrency:
  group: recon
  cancel-in-progress: false

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: "1.25"

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y snapd
        sudo snap install amass

        go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
        go install github.com/tomnomnom/assetfinder@latest
        go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
        go install github.com/projectdiscovery/httpx/cmd/httpx@latest
        go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
        nuclei -update-templates
        echo "$HOME/go/bin" >> $GITHUB_PATH

    - name: Fetch & run recon engine
      env:
        RECON_ENGINE_URL: ${{ secrets.RECON_ENGINE_URL }}
        DOMAINS_URL: ${{ secrets.DOMAINS_URL }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        RESULTS_REPO: ${{ secrets.RESULTS_REPO }}
        RESULTS_REPO_TOKEN: ${{ secrets.RESULTS_REPO_TOKEN }}
      run: |
        curl -fsSL "$RECON_ENGINE_URL" -o recon-engine.sh
        if grep -q "<!DOCTYPE html>" recon-engine.sh; then
          echo "[!] ERROR: HTML downloaded instead of script"
          exit 1
        fi
        chmod +x recon-engine.sh
        ./recon-engine.sh
